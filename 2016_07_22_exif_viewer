#include <stdio.h>
#include <stdlib.h>
#include <winsock2.h>

#pragma comment(lib, "WS2_32.lib")

const unsigned char EXIF_SIGN[] = { 0xFF, 0xD8, 0xFF, 0xE1, 0x61, 0xC8, 0x45, 0x78, 0x69, 0x66, 0x00, 0x00 };

struct IFD_Field {
	unsigned short tagID;
	unsigned short typeID;
	unsigned int countOfComponents;
	unsigned int value;
};

struct GEO_TAG {
	int deg, deg_div;
	int min, min_div;
	int sec, sec_div;
};

int main() {
	char buf[1024];
	unsigned char in[1024];

	printf("JPG file path : ");
	scanf("%1024s", buf);

	FILE *fp = fopen(buf, "r");
	if (fp == NULL) {
		printf("[*] invalid file ...\n");
		return -1;
	}

	fread(in, 1, 12, fp);

	for (int i = 0; i < 12; ++i) {
		if (in[i] != EXIF_SIGN[i]) {
			printf("[*] non-Exif format file ...\n");
			return -1;
		}
	}

	fread(in, 1, 4, fp);
	if (*((short *)&in) != 0x4D4D) {
		printf("[*] Couldn't analyse Little endian file ...\n");
		return -1;
	}

	unsigned int offset;
	fread(&offset, sizeof(int), 1, fp);
	offset = ntohl(offset);
	printf("[*] Exif Header offset : %d\n", offset);

	unsigned short fieldCount;
	fread(&fieldCount, sizeof(short), 1, fp);
	fieldCount = ntohs(fieldCount);
	printf("[*] Number of 0th IFD Field Count : %hd\n", fieldCount);

	IFD_Field gpsField;
	fread(&gpsField, sizeof(IFD_Field), 1, fp);
	gpsField.value = ntohl(gpsField.value);
	printf("[*] GPS offset : %d\n", gpsField.value);

	fseek(fp, 12 + gpsField.value, SEEK_SET);

	fread(&fieldCount, sizeof(short), 1, fp);
	fieldCount = ntohs(fieldCount);
	printf("[*] Number of GPS IFD Field Count : %hd\n", fieldCount);

	fseek(fp, sizeof(IFD_Field) * fieldCount + 4, SEEK_CUR);

	for (int i = 0; i < 2; ++i) {
		GEO_TAG temp;
		fread(&temp, sizeof(GEO_TAG), 1, fp);

		double deg = (double)temp.deg / temp.deg_div;
		double min = (double)temp.min / temp.min_div;
		double sec = (double)temp.sec / temp.sec_div;

		printf("%.02f`%.02f\"%d\'\n", deg, min, sec);
	}

	return 0;
}
